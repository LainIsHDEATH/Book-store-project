<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Set new password</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <script th:inline="javascript">
        // token приходит из URL на сервер, сервер положил в модель
        const RESET_TOKEN = /*[[${token}]]*/ "";

        (function () {
            // 1) убираем token из адресной строки, чтобы не светить его в логах/реферерах
            const url = new URL(window.location.href);
            url.searchParams.delete('token');
            window.history.replaceState({}, document.title, url.pathname + url.search);
        })();

        async function submitReset(e) {
            e.preventDefault();

            const form = e.target;
            const password = form.password.value;
            const confirm  = form.confirm.value;

            const err = document.getElementById("err");
            err.textContent = "";

            const resp = await fetch(form.action, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                    "X-Reset-Token": RESET_TOKEN
                },
                body: new URLSearchParams({ password, confirm })
            });

            const text = await resp.text();

            if (resp.ok && text === "ok") {
                window.location.href = "/auth/login?reset=true";
                return;
            }

            // примитивный маппинг ошибок
            const msg = ({
                "password_mismatch": "Passwords do not match",
                "weak_password": "Password is too weak (min 8 chars)",
                "invalid_or_expired": "Token is invalid or expired",
                "missing_token": "Missing token"
            })[text] || "Reset failed";

            err.textContent = msg;
        }
    </script>
</head>
<body>
<div th:insert="~{fragments/navbar :: topbar}"></div>

<div class="box">
    <h1>Set new password</h1>

    <div id="err" class="alert alert-err" style="display:block;"></div>

    <form th:action="@{/auth/password/reset}" method="post" class="form" onsubmit="submitReset(event)">
        <!-- fallback, если хочешь поддержать без JS: -->
        <input type="hidden" name="token" th:value="${token}"/>

        <div class="row">
            <input class="input" name="password" type="password" placeholder="New password" required/>
        </div>
        <br>
        <div class="row">
            <input class="input" name="confirm" type="password" placeholder="Repeat password" required/>
        </div>
        <br>
        <button class="btn btn-primary btn-wide" type="submit">Update password</button>
    </form>
</div>

</body>
</html>