<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Book store main page</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
<!--    <link rel="stylesheet" th:href="@{/css/index.css}">-->
    <link rel="stylesheet" th:href="@{/css/book-list-form.css}">
    <link rel="stylesheet" th:href="@{/css/index.css}">
    <script th:if="${stockErrBookId != null}">
        (function () {
            const url = new URL(window.location.href);
            url.searchParams.delete('stockErrBookId');
            window.history.replaceState({}, document.title, url.pathname + url.search);
        })();
    </script>
</head>
<body>
<div th:insert="~{fragments/navbar :: topbar}"></div>
<div class="container">

    <!-- Панель поиска/фильтров -->
    <form class="toolbar" th:action="@{/}" method="get">
        <input type="text" name="keyword" th:placeholder="#{home.search.placeholder}"
               th:value="${keyword}"/>

        <select name="ageGroup">
            <option value="" th:text="#{home.filter.age.all}">All age groups</option>
            <option th:each="ag : ${ageGroups}"
                    th:value="${ag}"
                    th:selected="${ag == ageGroup}"
                    th:text="#{ageGroup.__${ag}__}">
            </option>
        </select>

        <select name="genre">
            <option value="" th:text="#{home.filter.genre.all}">All genres</option>
            <option th:each="g : ${genres}"
                    th:value="${g}"
                    th:selected="${g == genre}"
                    th:text="#{${'genre.' + #strings.replace(g, ' ', '')}}">
            </option>
        </select>

        <select name="language">
            <option value="" th:text="#{home.filter.lang.all}">All languages</option>
            <option th:each="l : ${languages}"
                    th:value="${l}"
                    th:selected="${l == language}"
                    th:text="#{language.__${l}__}">
            </option>
        </select>

        <select name="sort">
            <option value="id_asc" th:selected="${sort == 'id_asc'}"
                    th:text="#{sort.id}">ID ↑</option>

            <option value="price_asc" th:selected="${sort == 'price_asc'}"
                    th:text="#{sort.priceAsc}">Price ↑</option>
            <option value="price_desc" th:selected="${sort == 'price_desc'}"
                    th:text="#{sort.priceDesc}">Price ↓</option>

            <option value="name_asc" th:selected="${sort == 'name_asc'}"
                    th:text="#{sort.nameAsc}">Name ↑</option>
            <option value="name_desc" th:selected="${sort == 'name_desc'}"
                    th:text="#{sort.nameDesc}">Name ↓</option>

            <option value="date_asc" th:selected="${sort == 'date_asc'}"
                    th:text="#{sort.dateAsc}">Date ↑</option>
            <option value="date_desc" th:selected="${sort == 'date_desc'}"
                    th:text="#{sort.dateDesc}">Date ↓</option>
        </select>

        <button class="btn btn-primary" type="submit" th:text="#{action.search}">Search</button>
        <a class="btn btn-secondary" th:href="@{/}" th:text="#{action.reset}">Reset</a>
    </form>

    <h2 th:text="#{home.title.availableBooks}">Available books</h2>

    <!-- Карточки книг -->
    <div class="grid">
        <div class="card" th:each="b : ${books.content}">
            <div class="title"
                 th:text="${#locale.language == 'uk' ? b.nameUk : b.nameEn}">
                Назва
            </div>

            <div class="meta">
                <span th:text="${#locale.language == 'uk' ? b.authorUk : b.authorEn}">Автор</span>
                • <span th:text="${#temporals.format(b.publicationDate, 'dd.MM.yyyy')}">date</span>
            </div>

            <div>
                <span class="badge" th:text="${#locale.language == 'uk' ? b.genreUk : b.genreEn}">GENRE</span>
                <span class="badge" th:text="#{language.__${b.language}__}">LANG</span>
                <span class="badge" th:text="#{ageGroup.__${b.ageGroup}__}">AGE</span>
            </div>

            <div class="price" th:text="${b.price} + ' ₴'">0 ₴</div>

            <div class="desc"
                 th:text="${#locale.language == 'uk' ? b.descriptionUk : b.descriptionEn}">
                Description
            </div>

            <!-- CART CONTROLS (only for CLIENT) -->
            <div class="cart-area" sec:authorize="hasRole('CLIENT')">

                <!-- If NOT in cart: show Add to cart -->
                <div th:if="${b.cartQuantity == null or b.cartQuantity == 0}">
                    <form th:action="@{/cart/add/{bookId}(bookId=${b.id})}" method="post">
                        <!--                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                        <button class="btn btn-primary btn-wide"
                                type="submit"
                                th:text="#{cart.add}">
                            Add to cart
                        </button>
                    </form>
                </div>

                <!-- If already in cart: show [- qty +] -->
                <div th:if="${b.cartQuantity != null and b.cartQuantity > 0}">
                    <div class="muted"
                         th:text="#{cart.inCartQty(${b.cartQuantity})}">
                        In cart: 1
                    </div>

                    <div class="qty-box">
                        <!-- minus -->
                        <form class="qty-form" th:action="@{/cart/minus/{bookId}(bookId=${b.id})}" method="post">
                            <!--                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                            <button class="qty-btn"
                                    type="submit"
                                    th:attr="aria-label=#{cart.minus}">
                                −
                            </button>
                        </form>

                        <!-- quantity -->
                        <div class="qty-mid" th:text="${b.cartQuantity}">1</div>

                        <!-- plus -->
                        <form class="qty-form" th:action="@{/cart/add/{bookId}(bookId=${b.id})}" method="post">
                            <!--                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->
                            <button class="qty-btn"
                                    type="submit"
                                    th:attr="aria-label=#{cart.plus}">
                                +
                            </button>
                        </form>
                    </div>
                </div>
                <div class="err"
                     th:if="${stockErrBookId != null and stockErrBookId == b.id}"
                     th:text="#{cart.error.stockExceeded}">
                    Stock exceeded
                </div>

            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" th:if="${books.totalPages > 1}">
        <a class="page-link"
           th:if="${books.hasPrevious()}"
           th:href="@{/(page=${books.number-1}, keyword=${keyword}, ageGroup=${ageGroup}, genre=${genre}, language=${language}, sort=${sort})}"
           th:text="#{pagination.prev}">
            Prev
        </a>

        <a class="page-link"
           th:each="p : ${#numbers.sequence(0, books.totalPages-1)}"
           th:classappend="${p == books.number} ? ' active' : ''"
           th:text="${p + 1}"
           th:href="@{/(page=${p}, keyword=${keyword}, ageGroup=${ageGroup}, genre=${genre}, language=${language})}">
        </a>

        <a class="page-link"
           th:if="${books.hasNext()}"
           th:href="@{/(page=${books.number+1}, keyword=${keyword}, ageGroup=${ageGroup}, genre=${genre}, language=${language})}"
           th:text="#{pagination.next}">
            Next
        </a>
    </div>

    <div class="muted" style="text-align:center; margin-top:8px;">
        <span th:text="#{pagination.pageOf(${books.number + 1}, ${books.totalPages})}">Page 1 / 10</span>
        <span> • </span>
        <span th:text="#{pagination.total(${books.totalElements})}">Total: 100</span>
    </div>

</div>
</body>
</html>